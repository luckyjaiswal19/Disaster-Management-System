{% extends "base.html" %}

{% block title %}User Dashboard - Disaster Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-info">
            <h4><i class="bi bi-person-circle"></i> Welcome, {{ current_user.name }}!</h4>
            <p class="mb-0">Monitor disaster events, request resources, or make donations to support relief efforts.</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- Quick Actions -->
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <h5><i class="bi bi-plus-circle"></i> Quick Actions</h5>
                <button class="btn btn-primary btn-sm w-100 mb-2" data-bs-toggle="modal" data-bs-target="#donateModal">
                    <i class="bi bi-gift"></i> Make Donation
                </button>
                <button class="btn btn-warning btn-sm w-100" data-bs-toggle="modal" data-bs-target="#requestModal">
                    <i class="bi bi-cart-plus"></i> Request Resources
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="col-md-9">
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h6>My Donations</h6>
                        <h3>{{ donations|length }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h6>My Requests</h6>
                        <h3>{{ requests|length }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h6>Active Events</h6>
                        <h3>{{ events|length }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h6>Resources</h6>
                        <h3>{{ resources|length }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Active Events Map -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-map"></i> Active Disaster Map</h5>
            </div>
            <div class="card-body p-0">
                <div id="map" style="height: 400px; width: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- Active Events List -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-task"></i> Event Details</h5>
            </div>
            <div class="card-body">
                {% if events %}
                <div class="list-group list-group-flush">
                    {% for event in events %}
                    <div class="list-group-item">
                        <h6 class="mb-1">{{ event.name }}</h6>
                        <p class="mb-1 small text-muted">{{ event.description }}</p>
                        <div class="d-flex justify-content-between">
                            <span
                                class="badge bg-{{ 'danger' if event.severity == 'Critical' else 'warning' if event.severity == 'High' else 'info' }}">
                                {{ event.severity }}
                            </span>
                            <small>Location: {{ "%.4f"|format(event.latitude) }}, {{ "%.4f"|format(event.longitude)
                                }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted p-3">No active events at the moment.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Available Resources -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-box-seam"></i> Available Resources</h5>
            </div>
            <div class="card-body">
                {% if resources %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Resource</th>
                                <th>Category</th>
                                <th>Available</th>
                                <th>Unit</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for resource in resources %}
                            <tr>
                                <td>{{ resource.name }}</td>
                                <td><span class="badge bg-secondary">{{ resource.category }}</span></td>
                                <td>
                                    <span
                                        class="badge bg-{{ 'success' if resource.available_quantity > 100 else 'warning' if resource.available_quantity > 20 else 'danger' }}">
                                        {{ resource.available_quantity }}
                                    </span>
                                </td>
                                <td>{{ resource.unit }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No resources available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-2">
    <!-- My Donations -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gift"></i> My Recent Donations</h5>
            </div>
            <div class="card-body">
                {% if donations %}
                <div class="list-group">
                    {% for donation in donations %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ donation.resource.name }}</h6>
                            <span class="badge bg-success">{{ donation.quantity }} {{ donation.resource.unit }}</span>
                        </div>
                        <p class="mb-1 small">
                            {% if donation.event %}
                            For: {{ donation.event.name }}
                            {% else %}
                            General Donation
                            {% endif %}
                        </p>
                        <small class="text-muted">{{ donation.donated_at.strftime('%Y-%m-%d %H:%M') }}</small>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">You haven't made any donations yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- My Requests -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cart"></i> My Recent Requests</h5>
            </div>
            <div class="card-body">
                {% if requests %}
                <div class="list-group">
                    {% for req in requests %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ req.resource.name }}</h6>
                            <span
                                class="badge bg-{{ 'warning' if req.status == 'Pending' else 'success' if req.status == 'Approved' else 'danger' }}">
                                {{ req.status }}
                            </span>
                        </div>
                        <p class="mb-1 small">
                            For: {{ req.event.name }}<br>
                            Quantity: {{ req.quantity }} {{ req.resource.unit }}<br>
                            Urgency: <span
                                class="badge bg-{{ 'danger' if req.urgency == 'Critical' else 'warning' if req.urgency == 'High' else 'info' }}">{{
                                req.urgency }}</span>
                        </p>
                        <small class="text-muted">{{ req.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">You haven't made any requests yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Donation Modal -->
<div class="modal fade" id="donateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-gift"></i> Make a Donation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/user/donate">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Resource</label>
                        <select class="form-select" name="resource_id" required>
                            <option value="">Select Resource</option>
                            {% for resource in resources %}
                            <option value="{{ resource.id }}">{{ resource.name }} ({{ resource.category }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" name="quantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Event (Optional)</label>
                        <select class="form-select" name="event_id">
                            <option value="">General Donation</option>
                            {% for event in events %}
                            <option value="{{ event.id }}">{{ event.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="2"
                            placeholder="Any additional information..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Donation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Request Modal -->
<div class="modal fade" id="requestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cart-plus"></i> Request Resources</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/user/request">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Resource *</label>
                        <select class="form-select" name="resource_id" required>
                            <option value="">Select Resource</option>
                            {% for resource in resources %}
                            <option value="{{ resource.id }}">{{ resource.name }} (Available: {{
                                resource.available_quantity }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Event *</label>
                        <select class="form-select" name="event_id" required>
                            <option value="">Select Event</option>
                            {% for event in events %}
                            <option value="{{ event.id }}">{{ event.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity *</label>
                        <input type="number" class="form-control" name="quantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Urgency</label>
                        <select class="form-select" name="urgency" required>
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Submit Request</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- Add Bootstrap JS for modals -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Map
        var map = L.map('map').setView([37.0902, -95.7129], 3); // Default view over US

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Fetch events and add markers
        fetch('/user/events')
            .then(response => response.json())
            .then(data => {
                var bounds = [];
                data.forEach(event => {
                    var marker = L.marker([event.latitude, event.longitude]).addTo(map);
                    marker.bindPopup(`<b>${event.name}</b><br>${event.description}<br>Severity: ${event.severity}`);
                    bounds.push([event.latitude, event.longitude]);
                });

                if (bounds.length > 0) {
                    map.fitBounds(bounds);
                }
            })
            .catch(error => console.error('Error loading map data:', error));
    });
</script>
{% endblock %}