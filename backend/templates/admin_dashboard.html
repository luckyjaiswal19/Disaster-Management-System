{% extends "base.html" %}

{% block title %}Admin Dashboard - Disaster Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning">
            <h4><i class="bi bi-shield-check"></i> Admin Dashboard</h4>
            <p class="mb-0">Manage disaster events, resources, and coordinate relief efforts.</p>
        </div>
    </div>
</div>

<!-- Statistics Row -->
<div class="row mb-4">
    <div class="col-md-2 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h5>{{ stats.total_users }}</h5>
                <small>Total Users</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h5>{{ stats.total_events }}</h5>
                <small>Active Events</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h5>{{ stats.total_requests }}</h5>
                <small>Total Requests</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h5>{{ stats.pending_requests }}</h5>
                <small>Pending Requests</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h5>{{ stats.total_donations }}</h5>
                <small>Total Donations</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center">
                <h5>{{ resources|length }}</h5>
                <small>Resources</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Pending Requests -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Pending Requests</h5>
                <span class="badge bg-warning">{{ pending_requests|length }} pending</span>
            </div>
            <div class="card-body">
                {% if pending_requests %}
                    <div class="list-group">
                        {% for req in pending_requests %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ req.user.name }}</h6>
                                <span class="badge bg-{{ 'danger' if req.urgency == 'Critical' else 'warning' if req.urgency == 'High' else 'info' }}">
                                    {{ req.urgency }}
                                </span>
                            </div>
                            <p class="mb-1">
                                <strong>{{ req.resource.name }}</strong> - 
                                {{ req.quantity }} {{ req.resource.unit }}
                            </p>
                            <p class="mb-1 small text-muted">
                                For: {{ req.event.name }}<br>
                                Available: {{ req.resource.available_quantity }} {{ req.resource.unit }}
                            </p>
                            <div class="btn-group btn-group-sm mt-2">
                                <form method="POST" action="/admin/request/{{ req.id }}/approve" class="d-inline">
                                    <button type="submit" class="btn btn-success btn-sm" 
                                            {% if req.quantity > req.resource.available_quantity %}disabled title="Insufficient quantity"{% endif %}>
                                        <i class="bi bi-check-lg"></i> Approve
                                    </button>
                                </form>
                                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#rejectModal{{ req.id }}">
                                    <i class="bi bi-x-lg"></i> Reject
                                </button>
                                <button class="btn btn-info btn-sm" onclick="viewRequestDetails({{ req.id }})">
                                    <i class="bi bi-info-circle"></i> Details
                                </button>
                            </div>
                            
                            <!-- Reject Modal -->
                            <div class="modal fade" id="rejectModal{{ req.id }}" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Reject Request</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <form method="POST" action="/admin/request/{{ req.id }}/reject">
                                            <div class="modal-body">
                                                <p>Reject request from <strong>{{ req.user.name }}</strong> for {{ req.quantity }} {{ req.resource.unit }} of {{ req.resource.name }}?</p>
                                                <div class="mb-3">
                                                    <label class="form-label">Reason for rejection (optional):</label>
                                                    <textarea class="form-control" name="comment" rows="3" placeholder="Provide reason for rejection..."></textarea>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-danger">Confirm Rejection</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No pending requests.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Resource Management -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-box-seam"></i> Resource Inventory</h5>
                <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addResourceModal">
                    <i class="bi bi-plus"></i> Add Resource
                </button>
            </div>
            <div class="card-body">
                {% if resources %}
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Resource</th>
                                    <th>Category</th>
                                    <th>Total</th>
                                    <th>Available</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for resource in resources %}
                                <tr>
                                    <td>
                                        <strong>{{ resource.name }}</strong>
                                        {% if resource.description %}
                                        <br><small class="text-muted">{{ resource.description[:50] }}...</small>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-secondary">{{ resource.category }}</span></td>
                                    <td>{{ resource.total_quantity }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if resource.available_quantity > 100 else 'warning' if resource.available_quantity > 20 else 'danger' }}">
                                            {{ resource.available_quantity }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if resource.available_quantity == 0 %}
                                            <span class="badge bg-danger">Out of Stock</span>
                                        {% elif resource.available_quantity < 20 %}
                                            <span class="badge bg-warning">Low Stock</span>
                                        {% else %}
                                            <span class="badge bg-success">Good</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No resources in inventory.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-2">
    <!-- Recent Donations -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gift"></i> Recent Donations</h5>
            </div>
            <div class="card-body">
                {% if donations %}
                    <div class="list-group">
                        {% for donation in donations %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ donation.user.name }}</h6>
                                <span class="badge bg-success">{{ donation.quantity }} {{ donation.resource.unit }}</span>
                            </div>
                            <p class="mb-1">
                                <strong>{{ donation.resource.name }}</strong>
                                {% if donation.event %}
                                    for {{ donation.event.name }}
                                {% endif %}
                            </p>
                            {% if donation.notes %}
                            <p class="mb-1 small text-muted">{{ donation.notes }}</p>
                            {% endif %}
                            <small class="text-muted">{{ donation.donated_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No recent donations.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- All Requests -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-check"></i> Recent Requests</h5>
            </div>
            <div class="card-body">
                {% if all_requests %}
                    <div class="list-group">
                        {% for req in all_requests %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ req.user.name }}</h6>
                                <span class="badge bg-{{ 'warning' if req.status == 'Pending' else 'success' if req.status == 'Approved' else 'danger' }}">
                                    {{ req.status }}
                                </span>
                            </div>
                            <p class="mb-1">
                                {{ req.resource.name }} - {{ req.quantity }} {{ req.resource.unit }}
                            </p>
                            <p class="mb-1 small text-muted">
                                For: {{ req.event.name }}
                                <br>Urgency: <span class="badge bg-{{ 'danger' if req.urgency == 'Critical' else 'warning' if req.urgency == 'High' else 'info' }}">{{ req.urgency }}</span>
                            </p>
                            <small class="text-muted">{{ req.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No requests found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Resource Modal -->
<div class="modal fade" id="addResourceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add New Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/admin/resource/add">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Resource Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" name="category" required>
                            <option value="">Select Category</option>
                            <option value="Food">Food</option>
                            <option value="Medical">Medical</option>
                            <option value="Shelter">Shelter</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Tools">Tools</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Initial Quantity</label>
                                <input type="number" class="form-control" name="quantity" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Unit</label>
                                <input type="text" class="form-control" name="unit" value="units">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Resource</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Bootstrap JS for modals -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
function viewRequestDetails(requestId) {
    // Simple details view - can be enhanced with AJAX
    alert('Request details for ID: ' + requestId + '\nThis can be enhanced with a proper modal showing detailed information.');
}

// Auto-close alerts after 5 seconds
setTimeout(function() {
    var alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
        var bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    });
}, 5000);
</script>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    background-color: rgba(0, 0, 0, 0.03);
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.list-group-item {
    border-left: none;
    border-right: none;
}

.list-group-item:first-child {
    border-top: none;
}

.list-group-item:last-child {
    border-bottom: none;
}

.btn-group .btn {
    margin-right: 0.25rem;
}
</style>
{% endblock %}